<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kuşhane</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="kushane_icon.png">
    <link rel="icon" type="image/png" href="kushane_icon.png">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playwrite+AU+TAS:wght@100..400&display=swap');
        :root { 
            --maroon: #800000; 
            --forest-green: #228B22; 
            --white-shadow: drop-shadow(0px 0px 3px white);
            --black-shadow: drop-shadow(0px 0px 3px black);
            --industrial-amber: #FF9700;
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            background: linear-gradient(rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.9)), url('pigeon_darkened.jpg') no-repeat center center fixed; 
            background-size: cover; 
            font-family: sans-serif; color: white; overflow: hidden; 
            display: flex; justify-content: center; align-items: stretch;
        }

        .vertical-column {
            width: 100%; max-width: 400px; position: relative; height: 100%;
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('pigeon_darkened.jpg') no-repeat center center;
            background-size: cover; display: flex; flex-direction: column; align-items: center;
            z-index: 10; box-sizing: border-box;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
        }

        .app-wrapper { width: 100%; padding: 120px 20px 20px 20px; display: flex; flex-direction: column; align-items: center; z-index: 102; }
        .app-title { font-family: 'Playwrite AU TAS', cursive; color: #000000 !important; font-weight: bold; -webkit-text-stroke: 1.5px white; paint-order: stroke fill; font-size: 2.3rem; margin-top: -10%; text-align: center; }
        
        .status-container {
            display: flex; align-items: center; justify-content: flex-start; align-self: flex-start;
            width: calc(90% + 20px); margin-top: 30%; margin-bottom: 30%;
            margin-left: -20px; background-color: rgba(0, 0, 0, 0.75);
            padding: 15px 5% 15px 5%; border-radius: 0 12px 12px 0; box-sizing: border-box;
        }

        .birdhouse-inline { width: 35px; height: 35px; flex-shrink: 0; background-image: url('birdhouse_icon.png'); background-size: contain; background-repeat: no-repeat; filter: var(--white-shadow); margin-right: 15px; margin-left: 5%; }
        .label-text { width: 75px; font-weight: bold; font-size: 1.6rem; white-space: nowrap; }
        #stat { width: 140px; font-weight: bold; font-size: 1.6rem; margin: 0; text-align: left; margin-left: 10%; color: gray; -webkit-text-stroke: 0.1px white; }
        
        .btn { width: 100%; height: 75px; border-radius: 18px; font-size: 1.5rem; font-weight: bold; color: white; border: none; filter: var(--black-shadow); margin-bottom: 15px; transition: opacity 0.3s; display: flex; justify-content: center; align-items: center; }
        .btn:disabled { opacity: 0.8; cursor: not-allowed; }
        #btn-open { background-color: var(--maroon); margin-top: 10%; }
        #btn-close { background-color: var(--forest-green); }

        .loader {
            display: inline-block; font-family: sans-serif; font-weight: bold;
            color: var(--industrial-amber); letter-spacing: 2px; position: relative;
            overflow: hidden; filter: drop-shadow(0px 0px 1px black);
        }
        .loader::after {
            content: attr(data-text); position: absolute; left: 0; top: 0;
            color: #000; width: 0%; height: 100%; overflow: hidden;
            animation: animloader 3s linear infinite; white-space: nowrap;
        }
        @keyframes animloader { 0% { width: 0%; } 100% { width: 100%; } }

        .conn-status { position: absolute; bottom: 30px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background-color: gray; }
        #statusText { font-weight: bold; }
    </style>
</head>
<body>
    <div class="vertical-column">
        <div id="main-app" class="app-wrapper">
            <div class="app-title">— Kuşhane —</div>
            <div class="status-container">
                <div class="birdhouse-inline"></div>
                <span class="label-text">Kapı:</span>
                <span id="stat">Beklemede</span>
            </div>
            <button id="btn-open" class="btn" onclick="sendCommand('acik')">AÇ</button>
            <button id="btn-close" class="btn" onclick="sendCommand('kapali')">KAPAT</button>
        </div>
        <div class="conn-status">
            <div id="dot" class="dot"></div>
            <span id="statusText">Cihaz Bekleniyor</span>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const myDeviceID = urlParams.get('device') || '00000000'; 
        
        const mqttOptions = {
            clientId: 'Kushane_PWA_' + Math.random().toString(16).substr(2, 8),
            username: 'kushane_admin', 
            password: 'pPBM8TpY!JWyz3S',
            clean: true,
            connectTimeout: 4000
        };

        const client = mqtt.connect('wss://9461d979ef2044fd9edf271202106b7c.s1.eu.hivemq.cloud:8884/mqtt', mqttOptions);

        function setButtonsEnabled(enabled) {
            document.getElementById('btn-open').disabled = !enabled;
            document.getElementById('btn-close').disabled = !enabled;
        }

        window.addEventListener('DOMContentLoaded', () => { 
            const statusText = document.getElementById('statusText');
            statusText.style.color = 'gray';
            statusText.style.webkitTextStroke = "0.1px white";
            setButtonsEnabled(false); 
        });

        client.on('connect', () => {
            client.subscribe(`kushane/${myDeviceID}/status`);
            client.subscribe(`kushane/${myDeviceID}/presence`);
        });

        client.on('message', (topic, message) => {
            const statusText = document.getElementById('statusText');
            const dot = document.getElementById('dot');
            const msg = message.toString();

            if (topic === `kushane/${myDeviceID}/presence`) {
                if (msg === 'online') {
                    statusText.innerText = 'Bağlı';
                    statusText.style.color = '#228B22'; 
                    statusText.style.webkitTextStroke = "0.1px white";
                    dot.style.backgroundColor = "#228B22";
                    setButtonsEnabled(true);
                } else {
                    statusText.innerText = 'Bağlı Değil';
                    statusText.style.color = '#800000'; 
                    statusText.style.webkitTextStroke = "0.1px white";
                    dot.style.backgroundColor = "#800000";
                    setButtonsEnabled(false);
                }
            }
        });

        client.on('offline', () => {
            const statusText = document.getElementById('statusText');
            statusText.innerText = 'Bağlı Değil';
            statusText.style.color = '#800000';
            setButtonsEnabled(false);
        });

        function broadcastDoorAction(action) {
            if (client.connected) {
                client.publish(`kushane/${myDeviceID}/control`, action === 'acik' ? '1' : '0', { qos: 1 });
            }
        }

        function sendCommand(cmd) {
            const btnOpen = document.getElementById('btn-open');
            const btnClose = document.getElementById('btn-close');
            const targetBtn = (cmd === 'acik') ? btnOpen : btnClose;
            const loaderMsg = (cmd === 'acik') ? 'Açılıyor' : 'Kapanıyor';
            broadcastDoorAction(cmd);
            btnOpen.disabled = true;
            btnClose.disabled = true;
            targetBtn.innerHTML = `<span class="loader" data-text="${loaderMsg}">${loaderMsg}</span>`;
            setTimeout(() => {
                btnOpen.innerHTML = "AÇ";
                btnClose.innerHTML = "KAPAT";
                updateVisuals(cmd);
            }, 3000);
        }

        function updateVisuals(status) {
            const s = document.getElementById('stat');
            const btnOpen = document.getElementById('btn-open');
            const btnClose = document.getElementById('btn-close');
            if (status === 'acik') { 
                s.innerText = "Açık"; s.style.color = "#800000"; 
                btnOpen.disabled = true; btnClose.disabled = false; 
            } else { 
                s.innerText = "Kapalı"; s.style.color = "#228B22"; 
                btnOpen.disabled = false; btnClose.disabled = true; 
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>

