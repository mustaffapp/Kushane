<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kuşhane</title>
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playwrite+AU+TAS:wght@100..400&display=swap');
        :root {
            --ac-aktif: #8B0000;
            --kapat-aktif: #228B22;
            --border-light: rgba(255, 255, 255, 0.15);
        }
        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background: #0f0f0f url('pigeon_darkened.jpg') no-repeat center center fixed;
            background-size: cover; display: flex; justify-content: center; align-items: center;
            font-family: sans-serif; overflow: hidden;
        }
        .app-wrapper {
            width: 100%; max-width: 400px; height: 100%;
            display: flex; flex-direction: column; align-items: flex-start; justify-content: center;
            position: relative; padding: 20px; box-sizing: border-box;
        }
        .top-icon {
            position: absolute; top: 30px; width: 1.6rem; height: 1.6rem;
            cursor: pointer; z-index: 100; opacity: 0.9;
            filter: drop-shadow(0.5px 0 0 white) drop-shadow(-0.5px 0 0 white) drop-shadow(0 0.5px 0 white) drop-shadow(0 -0.5px 0 white);
        }
        .pass-btn { left: 30px; }
        .settings-btn { right: 30px; }
        .app-title {
            align-self: center; font-family: 'Playwrite AU TAS', cursive;
            font-size: 2.32rem; color: #000000; font-weight: bold;
            -webkit-text-stroke: 1px white; paint-order: stroke fill;
            position: relative; top: -40px; margin-bottom: 25px;
        }
        .door-status-box { display: flex; align-items: center; margin-bottom: 40px; margin-left: 10%; }
        #bird-house-icon {
            width: 1.6em; height: 1.6em; margin-right: 20px;
            filter: drop-shadow(0.5px 0 0 white) drop-shadow(-0.5px 0 0 white) drop-shadow(0 0.5px 0 white) drop-shadow(0 -0.5px 0 white);
        }
        .door-label, #door-status-text { 
            font-size: 1.4rem; font-weight: bold; color: #000000;
            -webkit-text-stroke: 1px white; paint-order: stroke fill;
        }
        .controls-area { width: 100%; max-width: 320px; display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; align-self: center; }
        .btn { 
            width: 100%; padding: 22px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.1);
            font-size: 1.1rem; font-weight: bold; color: white; transition: all 0.4s ease; cursor: pointer;
        }
        .btn:not(.passive) { box-shadow: 0 8px 20px rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.25); }
        .btn.passive { opacity: 0.15; pointer-events: none; filter: grayscale(100%); }
        #btn-open { background-color: var(--ac-aktif); }
        #btn-close { background-color: var(--kapat-aktif); }
        .conn-status { 
            font-size: 0.8rem; font-weight: bold; display: flex; align-items: center; gap: 8px;
            -webkit-text-stroke: 0.3px white; paint-order: stroke fill; margin-left: 10%;
        }
        #conn-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .numpad-area {
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-light);
            border-radius: 30px; padding: 25px; width: 100%; max-width: 300px; text-align: center; align-self: center;
        }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .numpad button { 
            background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-light);
            border-radius: 12px; padding: 18px; font-size: 1.2rem; color: white;
        }
        #pass-display {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.2); 
            color: white; text-align: center; border-radius: 10px; border: 1px solid var(--border-light);
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <img class="top-icon pass-btn" src="lock_icon.png" onclick="resetAuth()">
        <img class="top-icon settings-btn" src="settings_icon.png" onclick="openSettings()">
        <div class="app-title">— Kuşhane —</div>
        <div class="door-status-box">
            <img id="bird-house-icon" src="birdhouse_icon.png">
            <span class="door-label">Kapı: </span>
            <span id="door-status-text"></span>
        </div>
        <div id="app-content" style="width:100%; display:flex; justify-content:center;"></div>
        <div class="conn-status">
            <span id="conn-dot"></span>
            <span id="conn-text">Bağlantı aranıyor</span>
        </div>
    </div>
    <script>
        let ESP32_IP = localStorage.getItem('kushane_ip') || "http://192.168.1.50";
        let isAuth = localStorage.getItem('kushane_auth') === 'true';
        let currentPass = "";

        function openSettings() {
            let newIP = prompt("IP:", ESP32_IP);
            if (newIP) { localStorage.setItem('kushane_ip', newIP); location.reload(); }
        }
        function resetAuth() { localStorage.removeItem('kushane_auth'); localStorage.removeItem('kushane_pass'); location.reload(); }

        function render() {
            const container = document.getElementById('app-content');
            if (!isAuth) {
                container.innerHTML = `<div class="numpad-area">
                    <input type="password" id="pass-display" readonly placeholder="ŞİFRE">
                    <div class="numpad">
                        ${[1,2,3,4,5,6,7,8,9].map(n => `<button onclick="addNum('${n}')">${n}</button>`).join('')}
                        <button onclick="clearPass()">⌫</button><button onclick="addNum('0')">0</button><button onclick="checkPass()">✓</button>
                    </div></div>`;
            } else {
                container.innerHTML = `<div class="controls-area">
                    <button id="btn-open" class="btn" onclick="send('open')">Aç</button>
                    <button id="btn-close" class="btn" onclick="send('close')">Kapat</button>
                </div>`;
                updateStatus(); 
            }
        }

        function addNum(n) { if(currentPass.length < 4) { currentPass += n; document.getElementById('pass-display').value = currentPass; } }
        function clearPass() { currentPass = currentPass.slice(0,-1); document.getElementById('pass-display').value = currentPass; }
        function checkPass() {
            if(currentPass.length === 4) {
                localStorage.setItem('kushane_pass', currentPass);
                localStorage.setItem('kushane_auth', 'true');
                isAuth = true; render();
            }
        }

        async function updateStatus() {
            const bOpen = document.getElementById('btn-open'), bClose = document.getElementById('btn-close');
            const dStatus = document.getElementById('door-status-text'), cText = document.getElementById('conn-text'), cDot = document.getElementById('conn-dot');
            if (!cText) return; 
            try {
                const res = await fetch(`${ESP32_IP}/status`, { signal: AbortSignal.timeout(2000) });
                const data = await res.json();
                cText.innerText = "Bağlı"; cText.style.color = "#228B22"; cDot.style.backgroundColor = "#228B22";
                if (data.locked) {
                    dStatus.innerText = "Kapalı"; dStatus.style.color = "#228B22";
                    if(bOpen) bOpen.classList.remove('passive'); if(bClose) bClose.classList.add('passive');
                } else {
                    dStatus.innerText = "Açık"; dStatus.style.color = "#8B0000";
                    if(bOpen) bOpen.classList.add('passive'); if(bClose) bClose.classList.remove('passive');
                }
            } catch (e) { 
                cText.innerText = "Bağlı değil"; cText.style.color = "#8B0000"; cDot.style.backgroundColor = "#8B0000";
                dStatus.innerText = "";
            }
        }

        async function send(act) {
            try { 
                await fetch(`${ESP32_IP}/control?action=${act}`, { 
                    method: 'POST', 
                    headers: { 'X-PASSWORD': localStorage.getItem('kushane_pass') } 
                }); 
                updateStatus(); 
            } catch (e) { updateStatus(); }
        }

        render();
        window.addEventListener('focus', updateStatus); 
    </script>
</body>
</html>

